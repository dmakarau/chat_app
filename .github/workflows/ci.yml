name: Flutter Development CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  # Code Quality and Testing
  test-and-analyze:
    name: Test & Code Quality
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: 'stable'
        cache: true

    - name: Print Flutter Version
      run: flutter --version

    - name: Install Dependencies
      run: flutter pub get

    - name: Verify Dependencies
      run: flutter pub deps

    - name: Generate Code (Mocks, etc.)
      run: |
        dart run build_runner build --delete-conflicting-outputs
        # Fix duplicate ignore comment generated by Mockito
        sed -i 's|^// ignore: must_be_immutable$||g' test/unit/models/chat_message_test.mocks.dart || true

    - name: Check Code Formatting
      run: dart format --output=none --set-exit-if-changed lib/models/ lib/services/ lib/screens/ lib/widgets/ lib/utils/ test/

    - name: Analyze Code (excluding Firebase config)
      run: flutter analyze --no-fatal-infos lib/models/ lib/services/ lib/screens/ lib/widgets/ lib/utils/ test/

    - name: Run Unit Tests
      run: flutter test test/unit/ --coverage

    - name: Run Widget Tests  
      run: flutter test test/widget/ --coverage

    - name: Run All Tests with Coverage
      run: flutter test --coverage

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      with:
        file: coverage/lcov.info
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false

  # Documentation Generation
  documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: 'stable'
        cache: true

    - name: Install Dependencies
      run: flutter pub get

    - name: Generate Code Documentation
      run: |
        dart doc lib/
        # Create index.html if it doesn't exist
        if [ ! -f doc/api/index.html ]; then
          echo "<html><head><title>Chat App Documentation</title></head><body><h1>Documentation</h1><p>Dart documentation generated successfully.</p></body></html>" > doc/api/index.html
        fi

    - name: Upload Documentation Artifact
      uses: actions/upload-pages-artifact@v3
      with:
        path: doc/api

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v4
      if: success()

  # Security and Dependency Checks
  security-check:
    name: Security & Dependencies
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.35.7'
        channel: 'stable'
        cache: true

    - name: Install Dependencies
      run: flutter pub get

    - name: Check for Outdated Dependencies
      run: flutter pub outdated

    - name: Run Dependency Audit
      run: dart pub deps

    - name: Check for Security Issues
      continue-on-error: true
      run: |
        echo "üîç Security Analysis:"
        # Check for common security issues (non-breaking)
        grep -r "http://" lib/ test/ || echo "‚úÖ No insecure HTTP URLs found"
        grep -r "TODO.*security\|FIXME.*security\|hack\|temporary" lib/ test/ || echo "‚úÖ No security-related TODOs found"
        echo "‚úÖ Security check completed"

  # Final Status Check
  ci-status:
    name: CI Status
    runs-on: ubuntu-latest
    needs: [test-and-analyze, security-check]
    if: always()

    steps:
    - name: Check Results
      run: |
        if [[ "${{ needs.test-and-analyze.result }}" == "success" ]]; then
          echo "‚úÖ Tests and Code Analysis: PASSED"
        else
          echo "‚ùå Tests and Code Analysis: FAILED"
          exit 1
        fi
        
        if [[ "${{ needs.security-check.result }}" == "success" ]]; then
          echo "‚úÖ Security Check: PASSED"
        else
          echo "‚ö†Ô∏è Security Check: Issues found (non-blocking)"
        fi
        
        echo ""
        echo "üéâ Development CI Pipeline Complete!"
        echo "üìä Tests: ${{ needs.test-and-analyze.result }}"
        echo "üîç Security: ${{ needs.security-check.result }}"
        echo "üìñ Documentation: Running independently"