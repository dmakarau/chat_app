name: Flutter CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  # Code Analysis and Testing
  analyze-and-test:
    name: Code Analysis & Testing
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: Print Flutter Version
      run: flutter --version

    - name: Install Dependencies
      run: flutter pub get

    - name: Verify Dependencies
      run: flutter pub deps

    - name: Generate Code (Mocks, etc.)
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Analyze Code
      run: flutter analyze

    - name: Check Code Formatting
      run: dart format --output=none --set-exit-if-changed .

    - name: Run Unit Tests
      run: flutter test --coverage

    - name: Run Widget Tests
      run: flutter test test/widget/ --coverage

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: coverage/lcov.info
        flags: unittests
        name: codecov-umbrella

  # Build for Android
  build-android:
    name: Build Android APK
    runs-on: ubuntu-latest
    needs: analyze-and-test

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: Install Dependencies
      run: flutter pub get

    - name: Generate Code
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Build Android APK (Debug)
      run: flutter build apk --debug

    - name: Build Android APK (Release)
      run: flutter build apk --release

    - name: Upload Android APK Artifact
      uses: actions/upload-artifact@v3
      with:
        name: android-apk
        path: build/app/outputs/flutter-apk/app-release.apk

  # Build for iOS (macOS runner required)
  build-ios:
    name: Build iOS
    runs-on: macos-latest
    needs: analyze-and-test

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: Install Dependencies
      run: flutter pub get

    - name: Generate Code
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Build iOS (No Codesign)
      run: flutter build ios --debug --no-codesign

    - name: Upload iOS Build Artifact
      uses: actions/upload-artifact@v3
      with:
        name: ios-build
        path: build/ios/

  # Security and Dependency Checks
  security-check:
    name: Security & Dependency Check
    runs-on: ubuntu-latest
    needs: analyze-and-test

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: Install Dependencies
      run: flutter pub get

    - name: Check for Outdated Dependencies
      run: flutter pub outdated

    - name: Run Dependency Audit
      run: dart pub deps

    - name: Check for Security Vulnerabilities
      continue-on-error: true
      run: |
        # Check for common security issues
        grep -r "http://" lib/ || echo "No insecure HTTP URLs found"
        grep -r "TODO.*security\|FIXME.*security\|hack\|temporary" lib/ || echo "No security-related TODOs found"

  # Performance and Size Analysis
  performance-analysis:
    name: Performance Analysis
    runs-on: ubuntu-latest
    needs: analyze-and-test

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: Install Dependencies
      run: flutter pub get

    - name: Generate Code
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Analyze Bundle Size
      run: flutter build apk --analyze-size

    - name: Generate Flutter Build Report
      run: |
        flutter build apk --release
        echo "APK Size Analysis:"
        ls -lh build/app/outputs/flutter-apk/

  # Documentation Generation
  documentation:
    name: Generate Documentation
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: Install Dependencies
      run: flutter pub get

    - name: Generate Documentation
      run: dart doc

    - name: Deploy Documentation to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      if: success()
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: doc/api

  # Deployment to Firebase (Optional - requires secrets)
  deploy-firebase:
    name: Deploy to Firebase
    runs-on: ubuntu-latest
    needs: [build-android, build-ios]
    if: github.ref == 'refs/heads/main' && success()

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Setup Flutter
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: Install Dependencies
      run: flutter pub get

    - name: Generate Code
      run: dart run build_runner build --delete-conflicting-outputs

    - name: Build Web
      run: flutter build web --release

    - name: Deploy to Firebase Hosting
      uses: FirebaseExtended/action-hosting-deploy@v0
      if: ${{ env.FIREBASE_SERVICE_ACCOUNT_KEY != '' }}
      with:
        repoToken: '${{ secrets.GITHUB_TOKEN }}'
        firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}'
        channelId: live
        projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
      env:
        FIREBASE_SERVICE_ACCOUNT_KEY: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_KEY }}

  # Notification on Success/Failure
  notify:
    name: Notification
    runs-on: ubuntu-latest
    needs: [analyze-and-test, build-android, build-ios]
    if: always()

    steps:
    - name: Notify Success
      if: ${{ needs.analyze-and-test.result == 'success' && needs.build-android.result == 'success' && needs.build-ios.result == 'success' }}
      run: |
        echo "‚úÖ All CI/CD checks passed successfully!"
        echo "üì± Android and iOS builds completed"
        echo "üß™ All tests passed"
        echo "üîç Code analysis passed"

    - name: Notify Failure
      if: ${{ needs.analyze-and-test.result == 'failure' || needs.build-android.result == 'failure' || needs.build-ios.result == 'failure' }}
      run: |
        echo "‚ùå CI/CD Pipeline Failed!"
        echo "üîç Check the logs above for details"
        echo "üìß Please fix the issues and try again"
        exit 1